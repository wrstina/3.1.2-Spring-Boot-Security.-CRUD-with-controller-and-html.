<!doctype html>
<html lang="ru" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Админ — пользователи</title>
    <meta name="_csrf" th:content="${_csrf.token}">
    <style>
        body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;margin:24px;background:#fafafa;color:#222}
        h1{margin:0 0 16px}
        .topbar{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px}
        .card{background:#fff;border:1px solid #ddd;border-radius:8px;padding:16px;margin-bottom:16px}
        table{width:100%;border-collapse:collapse;background:#fff}
        th,td{border:1px solid #ddd;padding:8px;vertical-align:top}
        th{background:#f2f2f2;text-align:left}
        .badges span{display:inline-block;background:#e5e7eb;border:1px solid #d1d5db;border-radius:4px;padding:2px 6px;margin-right:4px;font-size:12px}
        details>summary{cursor:pointer;color:#0b5ed7}
        .row-actions{display:flex;gap:8px;flex-wrap:wrap}
        .form-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
        .form-grid label{display:block;font-weight:600;margin-bottom:4px}
        .form-grid input,.form-grid select{width:100%;padding:6px;border:1px solid #ccc;border-radius:6px;background:#fff}
        .btn{padding:6px 10px;border:1px solid #bbb;border-radius:6px;background:#f6f6f6;cursor:pointer}
        .btn.primary{background:#0b5ed7;border-color:#0b5ed7;color:#fff}
        .btn.warn{background:#f59e0b;border-color:#f59e0b;color:#111}
        .btn.danger{background:#dc3545;border-color:#dc3545;color:#fff}
        .btn.link{background:transparent;border-color:#bbb}
    </style>
</head>
<body>

<div class="topbar">
    <h1>Панель администратора</h1>
    <div>
      <span th:if="${currentUser != null}">
        <strong th:text="${currentUser.username}">admin</strong>
        <span class="badges" th:if="${currentUser.roles != null}">
          <span th:each="r : ${currentUser.roles}"
                th:text="${#strings.replace(r.name,'ROLE_','')}">ADMIN</span>
        </span>
      </span>
        <!-- logout через POST -->
        <form th:action="@{/logout}" method="post" style="display:inline-block;margin-left:12px">
            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
            <button type="submit" class="btn">Выйти</button>
        </form>
    </div>
</div>

<!-- Создание -->
<div class="card">
    <h2 style="margin-top:0">Добавить нового пользователя</h2>
    <form th:action="@{/admin/users}" method="post" id="addUserForm">
        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
        <div class="form-grid">
            <div>
                <label>Username</label>
                <input name="username" required autocomplete="off" placeholder="Введите username">
            </div>
            <div>
                <label>Email</label>
                <input type="email" name="email" autocomplete="off" placeholder="Введите email">
            </div>
            <div>
                <label>Age</label>
                <input type="number" min="1" max="120" name="age" autocomplete="off" placeholder="Возраст">
            </div>
            <div>
                <label>Password</label>
                <input type="password" name="password" required autocomplete="new-password" placeholder="Введите пароль">
            </div>
            <div style="grid-column:1 / -1">
                <label>Роли (Ctrl/Cmd для множественного выбора)</label>
                <select name="roleIds" multiple size="3">
                    <option th:each="r : ${allRoles}"
                            th:value="${r.id}"
                            th:text="${#strings.replace(r.name,'ROLE_','')}">USER</option>
                </select>
            </div>
        </div>
        <div style="margin-top:12px">
            <button type="submit" class="btn primary">Создать</button>
            <button type="reset" class="btn">Очистить</button>
        </div>
    </form>
</div>

<!-- Таблица пользователей -->
<div class="card">
    <h2 style="margin-top:0">Список пользователей</h2>
    <table>
        <thead>
        <tr>
            <th style="width:70px">ID</th>
            <th>Username</th>
            <th>Email</th>
            <th style="width:80px">Age</th>
            <th>Роли</th>
            <th style="width:360px">Действия</th>
        </tr>
        </thead>
        <tbody>
        <tr th:each="u : ${users}">
            <td th:text="${u.id}">1</td>
            <td th:text="${u.username}">user</td>
            <td th:text="${u.email}">mail@x</td>
            <td th:text="${u.age}">30</td>
            <td class="badges">
          <span th:each="r : ${u.roles}"
                th:text="${#strings.replace(r.name,'ROLE_','')}">USER</span>
            </td>
            <td>
                <div class="row-actions">
                    <!-- Редактирование: нативный details с формой -->
                    <details>
                        <summary class="btn link">Редактировать</summary>
                        <form th:action="@{|/admin/users/${u.id}|}" method="post" style="margin-top:8px">
                            <input type="hidden" name="_method" value="put">
                            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
                            <div class="form-grid">
                                <div>
                                    <label>Username</label>
                                    <input name="username" th:value="${u.username}" required>
                                </div>
                                <div>
                                    <label>Email</label>
                                    <input type="email" name="email" th:value="${u.email}">
                                </div>
                                <div>
                                    <label>Age</label>
                                    <input type="number" min="0" name="age" th:value="${u.age}">
                                </div>
                                <div>
                                    <label>Password (опционально)</label>
                                    <input type="password" name="password" placeholder="не заполняйте, чтобы не менять">
                                </div>
                                <div style="grid-column:1 / -1">
                                    <label>Роли</label>
                                    <select name="roleIds" multiple size="3">
                                        <option th:each="r : ${allRoles}"
                                                th:value="${r.id}"
                                                th:text="${#strings.replace(r.name,'ROLE_','')}"
                                                th:selected="${#lists.contains(u.roles, r)}">USER</option>
                                    </select>
                                </div>
                            </div>
                            <div style="margin-top:8px">
                                <button type="submit" class="btn warn">Сохранить</button>
                            </div>
                        </form>
                    </details>

                    <!-- Удаление: нативный details с подтверждением -->
                    <details>
                        <summary class="btn link" style="color:#dc3545">Удалить</summary>
                        <form th:action="@{|/admin/users/${u.id}|}" method="post" style="margin-top:8px">
                            <input type="hidden" name="_method" value="delete">
                            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
                            <div>Удалить пользователя <strong th:text="${u.username}">user</strong>?</div>
                            <div style="margin-top:8px">
                                <button type="submit" class="btn danger">Удалить</button>
                            </div>
                        </form>
                    </details>
                </div>
            </td>
        </tr>

        <tr th:if="${#lists.isEmpty(users)}">
            <td colspan="6" style="text-align:center;color:#666;padding:16px">
                Пользователи отсутствуют
            </td>
        </tr>
        </tbody>
    </table>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Очистка формы добавления при загрузке страницы
        const addForm = document.getElementById('addUserForm');
        if (addForm) {
            // Очищаем форму
            addForm.reset();

            // Принудительно очищаем все текстовые поля
            const inputs = addForm.querySelectorAll('input[type="text"], input[type="email"], input[type="number"]');
            inputs.forEach(input => {
                input.value = '';
            });

            // Очищаем выбранные роли
            const roleSelect = addForm.querySelector('select[name="roleIds"]');
            if (roleSelect) {
                Array.from(roleSelect.options).forEach(option => {
                    option.selected = false;
                });
            }
        }
    });
</script>

</body>
</html>