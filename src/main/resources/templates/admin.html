<!doctype html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="utf-8" />
    <title>Admin panel</title>
    <link
            href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
            rel="stylesheet">
</head>
<body class="bg-light">

<nav class="navbar navbar-dark bg-dark mb-4">
    <div class="container">
        <span class="navbar-brand">Admin Panel</span>
        <a class="btn btn-outline-light btn-sm" th:href="@{/logout}">Logout</a>
    </div>
</nav>

<div class="container">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h3 class="m-0">Users Management</h3>
        <button id="btnOpenAdd" type="button" class="btn btn-primary">Add User</button>
    </div>

    <div class="table-responsive">
        <table class="table table-hover align-middle">
            <thead class="table-light">
            <tr>
                <th style="width: 70px;">ID</th>
                <th>Username</th>
                <th>Email</th>
                <th style="width: 90px;">Age</th>
                <th>Roles</th>
                <th style="width: 160px;">Actions</th>
            </tr>
            </thead>
            <tbody>
            <tr th:each="u : ${users}">
                <td th:text="${u.id}">1</td>
                <td th:text="${u.username}">user</td>
                <td th:text="${u.email}">mail@x</td>
                <td th:text="${u.age}">30</td>

                <!-- роли как бэйджи -->
                <td>
    <span th:each="r : ${u.roles}"
          class="badge text-bg-secondary me-1 role-badge"
          th:text="${#strings.replace(r.name,'ROLE_','')}">USER</span>
                </td>

                <td>
                    <button class="btn btn-sm btn-warning me-2 btn-edit"
                            type="button"
                            th:data-id="${u.id}"
                            th:data-username="${u.username}"
                            th:data-email="${u.email}"
                            th:data-age="${u.age}">
                        Edit
                    </button>

                    <button class="btn btn-sm btn-danger btn-del"
                            type="button"
                            th:data-id="${u.id}"
                            th:data-username="${u.username}">
                        Delete
                    </button>
                </td>
            </tr>

            <tr th:if="${#lists.isEmpty(users)}">
                <td colspan="6" class="text-center text-muted py-4">
                    Пользователи отсутствуют
                </td>
            </tr>
            </tbody>
        </table>
    </div>
</div>

<!-- ADD MODAL -->
<div class="modal fade" id="addUserModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <form class="modal-content" th:action="@{/admin/users}" method="post">
            <div class="modal-header">
                <h5 class="modal-title">Add user</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body row g-3">
                <div class="col-12">
                    <label class="form-label">Username</label>
                    <input class="form-control" name="username" required>
                </div>
                <div class="col-12">
                    <label class="form-label">Email</label>
                    <input class="form-control" type="email" name="email">
                </div>
                <div class="col-6">
                    <label class="form-label">Age</label>
                    <input class="form-control" type="number" name="age" min="0">
                </div>
                <div class="col-6">
                    <label class="form-label">Password</label>
                    <input class="form-control" type="password" name="password" required>
                </div>
                <div class="col-12">
                    <label class="form-label">Roles</label>
                    <select class="form-select" name="roleIds" multiple size="2">
                        <option th:each="r : ${allRoles}" th:value="${r.id}"
                                th:text="${#strings.replace(r.name,'ROLE_','')}">USER</option>
                    </select>
                </div>

                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Close</button>
                <button type="submit" class="btn btn-success">Add</button>
            </div>
        </form>
    </div>
</div>

<!-- EDIT MODAL -->
<div class="modal fade" id="editUserModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <form class="modal-content" th:action="@{/admin/users/{id}(id=${0})}" method="post">
            <input type="hidden" name="_method" value="put"/>
            <div class="modal-header">
                <h5 class="modal-title">Edit user</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body row g-3">
                <input type="hidden" name="id" id="edit-id">
                <div class="col-12">
                    <label class="form-label">Username</label>
                    <input class="form-control" name="username" id="edit-username" required>
                </div>
                <div class="col-12">
                    <label class="form-label">Email</label>
                    <input class="form-control" type="email" name="email" id="edit-email">
                </div>
                <div class="col-6">
                    <label class="form-label">Age</label>
                    <input class="form-control" type="number" name="age" id="edit-age" min="0">
                </div>
                <div class="col-6">
                    <label class="form-label">Password</label>
                    <input class="form-control" type="password" name="password" placeholder="(leave empty to keep)">
                </div>
                <div class="col-12">
                    <label class="form-label">Roles</label>
                    <select class="form-select" name="roleIds" id="edit-roles" multiple size="2">
                        <option th:each="r : ${allRoles}" th:value="${r.id}"
                                th:text="${#strings.replace(r.name,'ROLE_','')}">USER</option>
                    </select>
                </div>
                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Close</button>
                <button type="submit" class="btn btn-warning">Save</button>
            </div>
        </form>
    </div>
</div>

<!-- DELETE MODAL -->
<div class="modal fade" id="deleteUserModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <form class="modal-content" th:action="@{/admin/users/{id}(id=${0})}" method="post">
            <input type="hidden" name="_method" value="delete"/>
            <div class="modal-header">
                <h5 class="modal-title">Delete user</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" name="id" id="del-id">
                <p class="mb-0">Удалить пользователя <strong id="del-username">username</strong>?</p>
                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Close</button>
                <button type="submit" class="btn btn-danger">Delete</button>
            </div>
        </form>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
    // ---------- OPEN ADD ----------
    document.getElementById('btnOpenAdd').addEventListener('click', () => {
        const modal = new bootstrap.Modal(document.getElementById('addUserModal'));
        modal.show();
    });

    // ---------- OPEN EDIT (fill fields) ----------
    document.querySelectorAll('.btn-edit').forEach(btn => {
        btn.addEventListener('click', e => {
            const m = new bootstrap.Modal(document.getElementById('editUserModal'));
            document.getElementById('edit-id').value        = btn.dataset.id;
            document.getElementById('edit-username').value  = btn.dataset.username || '';
            document.getElementById('edit-email').value     = btn.dataset.email || '';
            document.getElementById('edit-age').value       = btn.dataset.age || '';

            // отметить роли (ожидаем строку вида "ROLE_USER,ROLE_ADMIN")
            const rolesStr = btn.dataset.roles || '';
            const selected = rolesStr.split(',').map(s => s.trim());
            const select   = document.getElementById('edit-roles');
            [...select.options].forEach(o => {
                // значение в option — ID роли; помечаем всё, либо подставь соответствие при необходимости
                o.selected = selected.some(s => s.endsWith(o.text.toUpperCase()));
            });

            // поправить action с /{id}
            const form = document.querySelector('#editUserModal form');
            form.action = form.action.replace(/\/\d*$/, '') + '/' + btn.dataset.id;

            m.show();
        });
    });

    // ---------- OPEN DELETE ----------
    document.querySelectorAll('.btn-del').forEach(btn => {
        btn.addEventListener('click', () => {
            const m = new bootstrap.Modal(document.getElementById('deleteUserModal'));
            document.getElementById('del-id').value = btn.dataset.id;
            document.getElementById('del-username').textContent = btn.dataset.username;

            const form = document.querySelector('#deleteUserModal form');
            form.action = form.action.replace(/\/\d*$/, '') + '/' + btn.dataset.id;

            m.show();
        });
    });
</script>
</body>
</html>